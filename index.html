<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Docker NAS Container Creator</title>
  <style>
    :root{
      --btn-pad:8px 12px;
      --btn-font:12px;
      --radius:6px;
      --icon-w:44px;
      --icon-h:36px;
    }
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px; }
    .container { max-width: 1000px; margin: 0 auto; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-top: 0; }
    label { font-weight: bold; display: block; margin: 12px 0 6px; }
    input, select, button, textarea {
      width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;
    }
    input[type="checkbox"], input[type="radio"] { width: auto; margin-right: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { font-size: 12px; color: #666; margin-top: 4px; }
    .inline { display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap: wrap; }
    .env-block { border: 1px dashed #ccc; border-radius: var(--radius); padding: 12px; background: #fafafa; }

    /* Buttons */
    button { background:#007bff; color:#fff; border:none; margin-top:15px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .secondary { background:#6c757d; }
    .secondary:hover { background:#545b62; }
    .success { background:#28a745; }
    .success:hover { background:#218838; }
    .danger { background:#dc3545; }
    .danger:hover { background:#b02a37; }
    .btn-small{ padding: var(--btn-pad); font-size: var(--btn-font); border-radius: var(--radius); }
    .btn-block{ width:100%; }
    .gridbtn { margin-top: 0; }
    .btn-icon { width: var(--icon-w); height: var(--icon-h); padding:0; line-height: var(--icon-h); text-align:center; }

    .error { color: #d00; margin: 10px 0; }
    .output-container { margin-top: 20px; display: none; }
    .output { background: #f1f1f1; padding: 12px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; }
    .hidden { display: none; }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Shares grid */
    .shares-wrap { border:1px solid #e5e5e5; border-radius:8px; padding:12px; background:#fafafa; }
    .shares-grid {
      display:grid;
      grid-template-columns: 2.0fr 1.2fr 1.6fr auto 0.7fr 0.7fr auto;
      gap:10px; align-items:center;
    }
    .shares-grid .hdr { font-weight:700; font-size:13px; text-align:center; }
    .checkcell { display:flex; align-items:center; justify-content:center; gap:8px; }
    .checkcell span { font-weight:600; }
    .tiny { font-size:12px; }
    .cell-right { display:flex; justify-content:flex-end; align-items:center; }

    /* Users grid */
    .users-wrap { border:1px solid #e5e5e5; border-radius:8px; padding:12px; background:#fafafa; margin-top:18px; }
    .users-grid { display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:center; }
    .users-grid .hdr { font-weight:700; font-size:13px; text-align:center; }
    .cell-actions { display:flex; justify-content:flex-end; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Docker NAS Container Creator</h1>

    <label for="name">Container Name</label>
    <input type="text" id="name" value="nas-container"/>

    <!-- Ports -->
    <div class="inline">
      <input type="checkbox" id="allPorts"/>
      <label for="allPorts" style="margin:0; font-weight:600;">Expose all SMB ports (137,138,139,445)</label>
    </div>

    <label for="ports">Port(s)</label>
    <input type="text" id="ports" value="445" placeholder="445 or 137,138,139,445"/>
    <div class="muted">Enter one port (e.g. <code>445</code>) or multiple, comma-separated (e.g. <code>137,138,139,445</code>). Leave empty to expose no ports.</div>

    <!-- Inline global UID/GID (no .env mode) -->
    <div id="inlineCreds">
      <div class="row">
        <div>
          <label for="uid">User ID (UID)</label>
          <input type="number" id="uid" value="1000"/>
        </div>
        <div>
          <label for="gid">Group ID (GID)</label>
          <input type="number" id="gid" value="1000"/>
        </div>
      </div>
      <div class="muted tiny">Leave UID/GID empty to omit them from the command.</div>
    </div>

    <label for="restart">Restart Policy</label>
    <select id="restart">
      <option value="no">No</option>
      <option value="always">Always</option>
      <option value="unless-stopped" selected>Unless Stopped</option>
      <option value="on-failure">On Failure</option>
    </select>

    <!-- ENV MODE -->
    <h3 style="margin-top:18px;">Environment Variables</h3>
    <div class="env-block">
      <div class="inline">
        <input type="radio" name="envmode" id="envNone" value="none" checked>
        <label for="envNone" style="margin:0;">No .env (recommended for multi-user; passwords are in the command)</label>
      </div>

      <div class="inline">
        <input type="radio" name="envmode" id="envFile" value="file">
        <label for="envFile" style="margin:0;">Use external .env file</label>
      </div>
      <div id="envFileRow" class="row hidden" style="margin-top:8px;">
        <div>
          <label for="envPath">.env file path</label>
          <input type="text" id="envPath" value="./nas.env" placeholder="./nas.env"/>
        </div>
      </div>

      <div class="inline">
        <input type="radio" name="envmode" id="envEditor" value="editor">
        <label for="envEditor" style="margin:0;">Build .env here</label>
      </div>
      <div id="envEditorPanel" class="hidden" style="margin-top:8px;">
        <div class="row">
          <div>
            <label for="envFilename">.env filename for command & download</label>
            <input type="text" id="envFilename" value="./nas.env" placeholder="./nas.env"/>
          </div>
        </div>

        <div class="inline" style="gap:10px; margin-top:6px;">
          <button type="button" id="btnSyncToEnv" class="btn-small secondary gridbtn">Sync UI → .env</button>
          <button type="button" id="btnApplyFromEnv" class="btn-small secondary gridbtn">Apply .env → UI</button>
          <label class="inline" style="margin-left:auto;">
            <input type="checkbox" id="includeUsersFromEnv"/>
            <span class="tiny">Include users from .env in command</span>
          </label>
        </div>

        <label for="envText" style="margin-top:10px;">.env contents</label>
        <textarea id="envText"># Use "Sync UI → .env" to generate this from the current form.</textarea>

        <div class="inline" style="gap:12px;">
          <button type="button" id="btnValidateEnv" class="btn-small secondary gridbtn">Validate .env</button>
          <button type="button" class="btn-small success gridbtn" id="btnDownloadEnv">Download .env</button>
          <span id="envStatus" class="muted"></span>
        </div>
      </div>
    </div>

    <!-- USERS (multi-user) -->
    <h3 style="margin-top:18px;">Users (repeatable <code>-u "user;password"</code>)</h3>
    <div id="usersWrap" class="users-wrap">
      <div class="users-grid" style="margin-bottom:6px;">
        <div class="hdr">Username</div>
        <div class="hdr">Password</div>
        <div class="hdr">Remove</div>
      </div>
      <div id="usersList"></div>
      <button type="button" class="secondary btn-small btn-block" id="btnAddUser">+ Add User</button>
      <div id="usersHint" class="muted tiny" style="margin-top:8px;">
        Users are included in the command only in **No .env** mode — unless you toggle “Include users from .env in command.”
      </div>
    </div>

    <!-- MULTI-SHARE / MULTI-PATH SUPPORT -->
    <h3 style="margin-top:18px;">Shares & Paths (multiple supported)</h3>
    <div class="shares-wrap">
      <div class="shares-grid" style="margin-bottom:6px;">
        <div class="hdr">Host Path</div>
        <div class="hdr">Share Name</div>
        <div class="hdr">Allowed Users (comma)</div>
        <div class="hdr">Add All Users</div>
        <div class="hdr">Read-only</div>
        <div class="hdr">Guest</div>
        <div class="hdr">Remove</div>
      </div>
      <div id="sharesList"></div>
      <button type="button" class="secondary btn-small btn-block" id="btnAddShare">+ Add Share</button>
      <div class="muted tiny" style="margin-top:8px;">
        Each host path is bind-mounted into the container at a unique path (e.g. <code>/data0</code>, <code>/data1</code>).  
        If “Allowed Users” is empty → share is available to all users. Otherwise, only the listed usernames can access it.  
        <strong>Share names must be unique.</strong>
      </div>
    </div>

    <div id="error" class="error"></div>
    <button onclick="generateCommand()">Generate Docker Command</button>

    <div id="outputContainer" class="output-container">
      <h3>Generated Command:</h3>
      <div id="output" class="output"></div>
      <button class="success btn-small" onclick="copyCommand()">Copy</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    /* ---------- Utilities ---------- */
    function trimCSV(str) { return str.split(",").map(s => s.trim()).filter(Boolean); }
    function buildPortFlags(portsCSV, allPortsChecked) {
      const text = (portsCSV || "").trim();
      if (!text) return "";
      const ports = trimCSV(text);
      if (ports.length === 1 && !allPortsChecked) return `-p ${ports[0]}:445`;
      return ports.map(p => `-p ${p}:${p}`).join(" ");
    }
    function buildShare(flagPath, name, readOnly, guest, allowedUsersCSV) {
      const ro = readOnly ? "yes" : "no";
      const ga = guest ? "yes" : "no";
      const usersField = (allowedUsersCSV || "").trim() ? trimCSV(allowedUsersCSV).join(",") : "all";
      return `-s "${name};${flagPath};${ro};${ga};no;${usersField};none"`;
    }
    function multilineify(parts) { return parts.map((p,i)=> i===0?p:("  "+p)).join(" \\\n"); }
    function parseEnv(text) {
      const lines = text.split(/\r?\n/), out = {};
      for (const raw of lines) {
        const line = raw.trim(); if (!line || line.startsWith("#")) continue;
        const eq = line.indexOf("="); if (eq === -1) continue;
        out[line.slice(0,eq).trim()] = line.slice(eq+1).trim();
      }
      return out;
    }
    function download(filename, content) {
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = filename.replace(/^.*\//,"");
      document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
    }

    /* ---------- Ports toggle ---------- */
    const allPortsEl = $("allPorts"), portsEl = $("ports");
    allPortsEl.addEventListener("change", () => {
      if (allPortsEl.checked) {
        portsEl.placeholder = "137,138,139,445";
        if (!portsEl.value.trim() || portsEl.value.trim()==="445") portsEl.value = "137,138,139,445";
      } else {
        portsEl.placeholder = "445";
        const vals = trimCSV(portsEl.value);
        if (vals.length !== 1) portsEl.value = "445";
      }
    });

    /* ---------- ENV mode ---------- */
    const envNoneEl=$("envNone"), envFileEl=$("envFile"), envEditorEl=$("envEditor");
    const envFileRow=$("envFileRow"), envEditorPanel=$("envEditorPanel");
    const includeUsersFromEnvEl=$("includeUsersFromEnv");
    const usersWrap=$("usersWrap"), usersHint=$("usersHint"), inlineCreds=$("inlineCreds");

    function refreshEnvMode(){
      inlineCreds.classList.add("hidden"); envFileRow.classList.add("hidden"); envEditorPanel.classList.add("hidden"); usersWrap.classList.remove("hidden");
      if (envNoneEl.checked){ inlineCreds.classList.remove("hidden"); usersWrap.classList.remove("hidden"); usersHint.textContent='Users are included in the command as -u entries.'; }
      else if (envFileEl.checked){ envFileRow.classList.remove("hidden"); usersWrap.classList.add("hidden"); }
      else if (envEditorEl.checked){ envEditorPanel.classList.remove("hidden"); usersWrap.classList.add("hidden"); }
    }
    [envNoneEl,envFileEl,envEditorEl].forEach(el=>el.addEventListener("change",refreshEnvMode));
    // Ensure the correct initial visibility
    document.addEventListener("DOMContentLoaded", refreshEnvMode);

    /* ---------- Users (multi-user) ---------- */
    const usersList=$("usersList"), btnAddUser=$("btnAddUser");
    function userRowTemplate(username="user", password="password"){
      return `
        <div class="users-grid">
          <input type="text" class="u-username" value="${username}" placeholder="username"/>
          <input type="password" class="u-password" value="${password}" placeholder="password"/>
          <div class="cell-actions">
            <button type="button" class="danger btn-icon gridbtn u-remove">X</button>
          </div>
        </div>`;
    }
    function addUserRow(u,p){ const w=document.createElement("div"); w.innerHTML=userRowTemplate(u,p); const row=w.firstElementChild; usersList.appendChild(row); row.querySelector(".u-remove").addEventListener("click",()=>row.remove()); }
    addUserRow("user","password"); btnAddUser.addEventListener("click",()=>addUserRow("",""));
    function getCurrentUsernames(){ return [...usersList.querySelectorAll(".u-username")].map(i=>i.value.trim()).filter(Boolean); }
    function getCurrentUsers(){ return [...usersList.querySelectorAll(".users-grid")].map(r=>({ username:r.querySelector(".u-username").value.trim(), password:r.querySelector(".u-password").value.trim() })).filter(u=>u.username||u.password); }

    /* ---------- Shares (multi-path) ---------- */
    const sharesList=$("sharesList"), btnAddShare=$("btnAddShare");
    function shareRowTemplate(idx, hostPath="/path/to/server", shareName="shared", allowed="", ro=false, guest=false){
      const mountPath=`/data${idx}`;
      return `
        <div class="shares-grid" data-index="${idx}">
          <input type="text" class="hostPath" value="${hostPath}" placeholder="/absolute/host/path"/>
          <input type="text" class="shareName" value="${shareName}" placeholder="share-name"/>
          <input type="text" class="allowedUsers" value="${allowed}" placeholder="user1,user2"/>
          <div class="cell-right">
            <button type="button" class="secondary btn-small gridbtn btnAllUsers">Add All Users</button>
          </div>
          <div class="checkcell">
            <input type="checkbox" class="readOnly" ${ro?"checked":""}/><span>RO</span>
          </div>
          <div class="checkcell">
            <input type="checkbox" class="guest" ${guest?"checked":""}/><span>Guest</span>
          </div>
          <div class="cell-right">
            <button type="button" class="danger btn-icon gridbtn btnRemove">X</button>
          </div>
          <input type="hidden" class="mountPath" value="${mountPath}"/>
        </div>`;
    }
    function refreshIndices(){ [...sharesList.querySelectorAll(".shares-grid")].forEach((row,i)=>{ row.dataset.index=i; const hidden=row.querySelector(".mountPath"); if (hidden) hidden.value=`/data${i}`; }); }
    function wireShareRow(row){
      row.querySelector(".btnRemove").addEventListener("click",()=>{ row.remove(); refreshIndices(); });
      row.querySelector(".btnAllUsers").addEventListener("click",()=>{ const names=getCurrentUsernames(); row.querySelector(".allowedUsers").value=names.join(","); });
    }
    function addShareRow(hostPath,shareName,allowed,ro,guest){ const idx=sharesList.querySelectorAll(".shares-grid").length; const w=document.createElement("div"); w.innerHTML=shareRowTemplate(idx,hostPath,shareName,allowed,ro,guest); const row=w.firstElementChild; sharesList.appendChild(row); wireShareRow(row); }
    addShareRow("/path/to/server","shared","",false,false);
    btnAddShare.addEventListener("click",()=>addShareRow("","shared","",false,false));

    /* ---------- .env Sync (UI -> .env and .env -> UI) ---------- */
    const envTextEl = $("envText");
    const envFilenameEl = $("envFilename");
    $("btnSyncToEnv").addEventListener("click", () => {
      envTextEl.value = buildEnvFromUI();
      $("envStatus").textContent = "Synced UI → .env";
      $("envStatus").style.color = "green";
    });
    $("btnApplyFromEnv").addEventListener("click", () => {
      applyEnvToUI(envTextEl.value);
      $("envStatus").textContent = "Applied .env → UI";
      $("envStatus").style.color = "green";
    });
    $("btnValidateEnv").addEventListener("click", () => {
      // Light validation only
      try { parseEnv(envTextEl.value); $("envStatus").textContent="Checked ✔"; $("envStatus").style.color="green"; }
      catch(e){ $("envStatus").textContent="Invalid .env"; $("envStatus").style.color="#d00"; }
    });
    $("btnDownloadEnv").addEventListener("click", () => {
      const filename = envFilenameEl.value.trim() || "nas.env";
      download(filename, envTextEl.value);
      $("envStatus").textContent = `Downloaded ${filename}`;
      $("envStatus").style.color = "green";
    });

    function buildEnvFromUI() {
      const lines = [];
      const ports = ($("ports").value || "").trim();
      if (ports) lines.push(`PORTS=${ports}`);
      const uid = $("uid").value.trim();
      const gid = $("gid").value.trim();
      if (uid) lines.push(`UID=${uid}`);
      if (gid) lines.push(`GID=${gid}`);
      lines.push(`RESTART=${$("restart").value}`);

      const users = getCurrentUsers().filter(u => u.username && u.password);
      if (users.length) lines.push(`USERS=${users.map(u => `${u.username}:${u.password}`).join(",")}`);

      const rows = [...sharesList.querySelectorAll(".shares-grid")];
      lines.push(`SHARE_COUNT=${rows.length}`);
      rows.forEach((row, i) => {
        const hostPath = row.querySelector(".hostPath").value.trim();
        const shareName = row.querySelector(".shareName").value.trim() || `share${i}`;
        const allowedUsers = row.querySelector(".allowedUsers").value.trim();
        const ro = row.querySelector(".readOnly").checked ? "yes" : "no";
        const guest = row.querySelector(".guest").checked ? "yes" : "no";
        const mountPath = `/data${i}`;
        lines.push(`MOUNT_${i}=${hostPath}:${mountPath}`);
        lines.push(`SHARE_${i}=name=${shareName};path=${mountPath};ro=${ro};guest=${guest};users=${allowedUsers||"all"}`);
      });
      return lines.join("\n");
    }

    function applyEnvToUI(text) {
      const env = parseEnv(text);

      // Ports / UID / GID / Restart
      if (env.PORTS !== undefined) $("ports").value = env.PORTS;
      $("uid").value = env.UID || "";
      $("gid").value = env.GID || "";
      if (env.RESTART) $("restart").value = env.RESTART;

      // Users
      if (env.USERS) {
        usersList.innerHTML = "";
        env.USERS.split(",").forEach(pair => {
          const [u,p] = pair.split(":");
          addUserRow(u||"", p||"");
        });
      }

      // Shares (support SHARE_COUNT or infer from keys)
      sharesList.innerHTML = "";
      let count = 0;
      if (env.SHARE_COUNT && /^\d+$/.test(env.SHARE_COUNT)) {
        count = parseInt(env.SHARE_COUNT, 10);
      } else {
        // infer by scanning keys
        Object.keys(env).forEach(k => { const m = k.match(/^SHARE_(\d+)$/); if (m) count = Math.max(count, parseInt(m[1],10)+1); });
      }
      for (let i = 0; i < count; i++) {
        const m = env[`MOUNT_${i}`];   // /host:/dataN
        const s = env[`SHARE_${i}`];   // name=..;path=/dataN;ro=yes;guest=no;users=...
        if (!m || !s) continue;
        const hostPath = (m.split(":")[0] || "").trim();
        const parts = Object.fromEntries(
          s.split(";").map(kv => {
            const [k,v] = kv.split("=");
            return [(k||"").trim(), (v||"").trim()];
          })
        );
        addShareRow(
          hostPath,
          parts.name || `share${i}`,
          parts.users==="all"?"":parts.users,
          parts.ro==="yes",
          parts.guest==="yes"
        );
      }
      refreshIndices();
    }

    /* ---------- Command generation ---------- */
    function generateCommand(){
      const name=$("name").value.trim(), restart=$("restart").value, errorEl=$("error"); errorEl.textContent="";
      const rows=[...sharesList.querySelectorAll(".shares-grid")]; if (rows.length===0){ errorEl.textContent="Add at least one share."; return; }
      const shares=[];
      for (const row of rows){
        const hostPath=row.querySelector(".hostPath").value.trim();
        const shareName=row.querySelector(".shareName").value.trim();
        const allowedUsers=row.querySelector(".allowedUsers").value.trim();
        const ro=row.querySelector(".readOnly").checked;
        const guest=row.querySelector(".guest").checked;
        const mountPath=row.querySelector(".mountPath").value.trim();
        if (!hostPath){ errorEl.textContent="Every share needs a Host Path."; return; }
        if (!shareName){ errorEl.textContent="Every share needs a Share Name."; return; }
        shares.push({hostPath,shareName,allowedUsers,ro,guest,mountPath});
      }
      const seen=new Map(), dups=new Set();
      for (const s of shares){ const key=s.shareName.toLowerCase(); if (seen.has(key)) dups.add(s.shareName); else seen.set(key,true); }
      if (dups.size){ errorEl.textContent=`Share names must be unique. Duplicates found: ${[...dups].join(", ")}`; return; }

      let useEnv=false, envFilePath="", inlineUID=$("uid").value.trim(), inlineGID=$("gid").value.trim();
      let users=[];
      if (envNoneEl.checked){
        users=getCurrentUsers();
        if (users.length===0){ errorEl.textContent="Add at least one user (or switch to a .env mode)."; return; }
        for (const u of users){ if (!u.username||!u.password){ errorEl.textContent="Each user needs both username and password."; return; } }
        const nameSet=new Set(users.map(u=>u.username));
        for (const s of shares){ if (!s.allowedUsers) continue; const missing=trimCSV(s.allowedUsers).filter(n=>!nameSet.has(n)); if (missing.length){ errorEl.textContent=`Share "${s.shareName}" lists unknown user(s): ${missing.join(", ")}.`; return; } }
      } else if (envFileEl.checked){
        useEnv=true; envFilePath=$("envPath").value.trim(); if (!envFilePath){ errorEl.textContent="Please provide a path to your external .env file."; return; }
      } else {
        useEnv=true; envFilePath=$("envFilename").value.trim()||"./nas.env";
        if (includeUsersFromEnvEl.checked){
          const envObj=parseEnv(envTextEl.value);
          if (envObj.USERS){ users=envObj.USERS.split(",").map(p=>{ const [u,pw]=p.split(":"); return {username:(u||"").trim(), password:(pw||"").trim()}; }).filter(u=>u.username&&u.password); }
          const nameSet=new Set(users.map(u=>u.username));
          for (const s of shares){ if (!s.allowedUsers) continue; const missing=trimCSV(s.allowedUsers).filter(n=>!nameSet.has(n)); if (missing.length){ errorEl.textContent=`Share "${s.shareName}" lists unknown user(s): ${missing.join(", ")}.`; return; } }
        }
      }

      const portFlags=buildPortFlags($("ports").value,$("allPorts").checked);
      const parts=["docker run -d"]; if (name) parts.push(`--name ${name}`); if (portFlags) parts.push(portFlags);
      for (let i=0;i<shares.length;i++){ parts.push(`-v ${shares[i].hostPath}:/data${i}`); }
      if (useEnv) parts.push(`--env-file ${envFilePath}`); else { if (inlineUID) parts.push(`-e UID=${inlineUID}`); if (inlineGID) parts.push(`-e GID=${inlineGID}`); }
      parts.push(`--restart ${restart}`); parts.push(`dperson/samba`);
      if (!useEnv || includeUsersFromEnvEl.checked){ for (const u of users) parts.push(`-u "${u.username};${u.password}"`); }
      for (let i=0;i<shares.length;i++){ const s=shares[i]; parts.push(buildShare(`/data${i}`, s.shareName, s.ro, s.guest, s.allowedUsers)); }
      $("output").textContent=multilineify(parts); $("outputContainer").style.display="block";
    }

    function copyCommand(){ navigator.clipboard.writeText($("output").textContent).then(()=>alert("Command copied!")); }
  </script>
</body>
</html>
